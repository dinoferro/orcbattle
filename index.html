<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WebXR + Three.js AR Battle</title>
  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;color:#fff;font-family:system-ui}
    #uiTop{
      position:fixed;top:10px;left:10px;right:10px;display:flex;gap:10px;justify-content:space-between;pointer-events:none;z-index:10
    }
    .panel{
      width:48%;
      background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px 12px;
      pointer-events:auto;
      backdrop-filter: blur(8px);
    }
    .name{font-weight:800;margin-bottom:6px}
    .bar{height:12px;background:rgba(255,255,255,.14);border-radius:999px;overflow:hidden}
    .fill{height:100%;width:100%;background:#3ddc84;transition:width .2s ease}
    .hp{font-size:12px;opacity:.9;margin-top:6px}

    #log{
      position:fixed;left:10px;right:10px;bottom:82px;max-height:140px;overflow:auto;
      background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.14);border-radius:14px;
      padding:10px 12px;font-size:13px;z-index:10;pointer-events:auto
    }
    #uiBottom{
      position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:8px;flex-wrap:wrap;z-index:10
    }
    button{
      flex:1;min-width:120px;
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.6);
      color:#fff;font-weight:800;cursor:pointer
    }
    button:disabled{opacity:.45;cursor:not-allowed}
    #startAR{
      position:fixed;left:10px;right:10px;top:62px;z-index:10
    }
    #status{
      position:fixed;left:10px;right:10px;top:110px;z-index:10;
      font-size:12px;opacity:.9
    }
    canvas{display:block}
  </style>
</head>

<body>
  <div id="uiTop">
    <div class="panel">
      <div class="name">üßô‚Äç‚ôÇÔ∏è Vos</div>
      <div class="bar"><div id="pFill" class="fill"></div></div>
      <div id="pHp" class="hp"></div>
    </div>
    <div class="panel">
      <div class="name">üëπ Orco</div>
      <div class="bar"><div id="eFill" class="fill"></div></div>
      <div id="eHp" class="hp"></div>
    </div>
  </div>

  <div id="startAR">
    <button id="btnStart">üì∑ Iniciar AR</button>
  </div>
  <div id="status"></div>

  <div id="log"></div>

  <div id="uiBottom">
    <button id="btnMagic">‚ú® Magia</button>
    <button id="btnHit">ü™Ñ Golpe</button>
    <button id="btnDef">üõ° Defender</button>
    <button id="btnReset">üîÅ Reiniciar</button>
  </div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";

  // ---- UI ----
  const pFill = document.getElementById("pFill");
  const eFill = document.getElementById("eFill");
  const pHp = document.getElementById("pHp");
  const eHp = document.getElementById("eHp");
  const logEl = document.getElementById("log");
  const statusEl = document.getElementById("status");

  const btnStart = document.getElementById("btnStart");
  const btnMagic = document.getElementById("btnMagic");
  const btnHit = document.getElementById("btnHit");
  const btnDef = document.getElementById("btnDef");
  const btnReset = document.getElementById("btnReset");

  function logLine(t){
    const d = document.createElement("div");
    d.textContent = t;
    logEl.appendChild(d);
    logEl.scrollTop = logEl.scrollHeight;
  }
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const rnd = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

  const state = {
    pMax:100, p:100,
    eMax:120, e:120,
    turn:true,
    defending:false,
    over:false,
    placed:false
  };

  function updateUI(){
    pFill.style.width = (state.p/state.pMax*100)+"%";
    eFill.style.width = (state.e/state.eMax*100)+"%";
    pHp.textContent = `HP: ${state.p}/${state.pMax}`;
    eHp.textContent = `HP: ${state.e}/${state.eMax}`;

    const disabled = !state.turn || state.over || !state.placed;
    btnMagic.disabled = disabled;
    btnHit.disabled = disabled;
    btnDef.disabled = disabled;
  }

  function endGame(win){
    state.over = true;
    logLine(win ? "üèÜ Ganaste." : "üíÄ Perdiste.");
    updateUI();
  }

  function enemyTurn(){
    state.turn = false;
    updateUI();
    setTimeout(()=>{
      if(state.over) return;
      let dmg = rnd(10,20);
      if(state.defending){
        dmg = Math.floor(dmg/2);
        state.defending = false;
        logLine("üõ° Defensa activa: da√±o reducido.");
      }
      state.p = clamp(state.p - dmg, 0, state.pMax);
      logLine(`üëπ El orco ataca y te quita ${dmg} HP.`);
      if(state.p <= 0) return endGame(false);
      state.turn = true;
      updateUI();
    }, 700);
  }

  function playerAttack(kind){
    if(!state.turn || state.over || !state.placed) return;
    const dmg = kind==="magic" ? rnd(18,32) : rnd(10,16);
    logLine(kind==="magic" ? `‚ú® Magia: ${dmg} da√±o.` : `ü™Ñ Golpe: ${dmg} da√±o.`);
    state.e = clamp(state.e - dmg, 0, state.eMax);
    updateUI();
    if(state.e <= 0) return endGame(true);
    enemyTurn();
  }

  btnMagic.onclick = ()=>playerAttack("magic");
  btnHit.onclick = ()=>playerAttack("hit");
  btnDef.onclick = ()=>{
    if(!state.turn || state.over || !state.placed) return;
    state.defending = true;
    logLine("üõ° Te defend√©s.");
    enemyTurn();
  };

  btnReset.onclick = ()=>{
    state.p = state.pMax; state.e = state.eMax;
    state.turn = true; state.defending = false; state.over = false;
    logEl.innerHTML = "";
    logLine("‚öî Listo. Coloc√° el orco y empez√° a atacar.");
    updateUI();
  };

  // ---- Three.js + WebXR (AR) ----
  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera();

  // Luz simple
  const light1 = new THREE.HemisphereLight(0xffffff, 0x222222, 1.0);
  scene.add(light1);

  // Ret√≠cula (hit test)
  const reticleGeo = new THREE.RingGeometry(0.08, 0.10, 32).rotateX(-Math.PI/2);
  const reticleMat = new THREE.MeshBasicMaterial({ color: 0x00ff99 });
  const reticle = new THREE.Mesh(reticleGeo, reticleMat);
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);

  // ‚ÄúOrco‚Äù placeholder: c√°psula + esfera (cambiable por GLB luego)
  const orcGroup = new THREE.Group();

  const body = new THREE.Mesh(
    new THREE.CapsuleGeometry(0.12, 0.25, 8, 16),
    new THREE.MeshStandardMaterial({ color: 0x2ecc71, roughness: 0.9, metalness: 0.0 })
  );
  body.position.y = 0.25;
  orcGroup.add(body);

  const head = new THREE.Mesh(
    new THREE.SphereGeometry(0.12, 18, 18),
    new THREE.MeshStandardMaterial({ color: 0x27ae60, roughness: 0.9, metalness: 0.0 })
  );
  head.position.y = 0.48;
  orcGroup.add(head);

  // ‚Äúarma‚Äù simple
  const club = new THREE.Mesh(
    new THREE.CylinderGeometry(0.02, 0.03, 0.28, 12),
    new THREE.MeshStandardMaterial({ color: 0x8e5a2a, roughness: 1.0, metalness: 0.0 })
  );
  club.rotation.z = Math.PI/3;
  club.position.set(0.18, 0.32, 0);
  orcGroup.add(club);

  orcGroup.visible = false;
  scene.add(orcGroup);

  // WebXR helpers
  let hitTestSource = null;
  let hitTestSourceRequested = false;
  let referenceSpace = null;

  async function startAR(){
    if(!navigator.xr){
      statusEl.textContent = "‚ùå WebXR no disponible. Prob√° en Chrome Android.";
      return;
    }

    // Requiere HTTPS (GitHub Pages OK)
    const supported = await navigator.xr.isSessionSupported("immersive-ar").catch(()=>false);
    if(!supported){
      statusEl.textContent = "‚ùå AR no soportado en este dispositivo/navegador. (Android + Chrome + ARCore)";
      return;
    }

    const session = await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["hit-test"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body }
    });

    renderer.xr.setReferenceSpaceType("local");
    await renderer.xr.setSession(session);

    statusEl.textContent = "‚úÖ AR iniciado. Apunt√° al piso y toc√° la pantalla para colocar el orco.";
    btnStart.disabled = true;

    session.addEventListener("end", ()=>{
      btnStart.disabled = false;
      statusEl.textContent = "";
      hitTestSource = null;
      hitTestSourceRequested = false;
      reticle.visible = false;
      orcGroup.visible = false;
      state.placed = false;
      updateUI();
    });

    // Colocar orco al tocar pantalla
    window.addEventListener("click", onTapToPlace, { passive:true });
  }

  function onTapToPlace(){
    if(!reticle.visible) return;
    orcGroup.visible = true;
    orcGroup.position.setFromMatrixPosition(reticle.matrix);
    // Orientaci√≥n b√°sica
    orcGroup.quaternion.setFromRotationMatrix(reticle.matrix);
    state.placed = true;
    logLine("üëπ Orco colocado. ¬°Atacalo!");
    updateUI();
  }

  btnStart.onclick = startAR;

  renderer.setAnimationLoop((timestamp, frame)=>{
    const session = renderer.xr.getSession();
    if(frame){
      const refSpace = renderer.xr.getReferenceSpace();

      if(!hitTestSourceRequested){
        hitTestSourceRequested = true;
        session.requestReferenceSpace("viewer").then((viewerSpace)=>{
          referenceSpace = viewerSpace;
          session.requestHitTestSource({ space: viewerSpace }).then((source)=>{
            hitTestSource = source;
          });
        });
      }

      if(hitTestSource){
        const hitTestResults = frame.getHitTestResults(hitTestSource);
        if(hitTestResults.length){
          const hit = hitTestResults[0];
          const pose = hit.getPose(refSpace);
          reticle.visible = true;
          reticle.matrix.fromArray(pose.transform.matrix);
        } else {
          reticle.visible = false;
        }
      }
    }

    // Animaci√≥n simple del ‚Äúorco‚Äù
    if(orcGroup.visible && !state.over){
      orcGroup.rotation.y += 0.005;
    }

    renderer.render(scene, camera);
  });

  window.addEventListener("resize", ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  // Init
  btnReset.click();
  updateUI();
</script>
</body>
</html>
